<!DOCTYPE html>
<html lang="en-us">
    <head>
        <style>
            a {
                word-wrap: break-word;
            }
        </style>
    </head>  
    <body>
        <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>How does ShardingSphere’s Show processlist &amp; Kill Work? &middot; ShardingSphere - Blog</title>

		
  		<link rel="stylesheet" href="https://shardingsphere.apache.org/blog/css/style.css">
		<link rel="stylesheet" href="https://shardingsphere.apache.org/blog/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="https://shardingsphere.apache.org/blog/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="https://shardingsphere.apache.org/blog/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="https://shardingsphere.apache.org/blog/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="ShardingSphere - Blog" />
	</head>

        <div style="position: sticky; position: -webkit-sticky; top: 0px; background-color: rgba(255, 255, 255, 0.888);">		<nav class="nav">
			<div class="nav-container">
				<a href="https://shardingsphere.apache.org/blog/">
					<h1 class="nav-title">ShardingSphere - Blog</h1>
				</a>

				<span style="padding-left: 65px;">
					
					
					<li>
						<a href="https://shardingsphere.apache.org/blog/en/material/">
							<h3>Articles</h3>
						</a>
					</li>
					
					<li>
						<a href="https://shardingsphere.apache.org/blog/en/videos/">
							<h3>Videos</h3>
						</a>
					</li>
					
				</span>

				<span style="position: relative; left: 75px; 
				background: rgba(0, 0, 0, 0.664);
				font-weight: bold;
				padding:0.1rem; 
				padding-left:15px; 
				padding-right:15px; 
				padding-top: 2px; 
				padding-bottom: 5px; 
				border-radius:10px;">
					
				</span>
			</div>
			</div>
		</nav></div>
        

<main>
	<div class="post">
		<h1 class="post-title">How does ShardingSphere’s Show processlist &amp; Kill Work?</h1>

		<div class="post-info">
        
</div>

		

		<p>For those of you who often use databases, you may wonder:</p>
<ol>
<li>
<p>How do I check what SQL is currently being executed by the database, and in what state?</p>
</li>
<li>
<p>How do I terminate abnormal SQL? For instance, if a <code>SELECT</code> statement used to query a table with massive data does not carry query conditions, it would drag down the performance of the entire database. This may push to want to terminate this abnormal SQL.</p>
</li>
</ol>
<p>In response to the above issues, <a href="https://shardingsphere.apache.org/">Apache ShardingSphere</a> introduced functions such as <code>Show processlist</code> and <code>Kill &lt;processID&gt;</code>.</p>
<p><img src="https://shardingsphere.apache.org/blog/img/2022_09_22_How_does_ShardingSphere%E2%80%99s_Show_processlist_&amp;_Kill_Work1.png" alt="img"></p>
<h1 id="1-introduction">1. Introduction</h1>
<p><code>Show processlist</code>: this command can display the list of SQL currently being executed by ShardingSphere and the execution progress of each SQL. If ShardingSphere is deployed in cluster mode, the <code>Show processlist</code> function aggregates the SQL running for all Proxy instances in the cluster and then displays the result, so you can always see all the SQL running at that moment.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> processlist <span style="color:#960050;background-color:#1e0010">\</span>G;
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. row <span style="color:#f92672">***************************</span>
     Id: <span style="color:#ae81ff">82</span>a67f254959e0a0807a00f3cd695d87
   <span style="color:#66d9ef">User</span>: root
   Host: <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">200</span>.<span style="color:#ae81ff">79</span>.<span style="color:#ae81ff">156</span>
     db: root
Command: Execute
   <span style="color:#66d9ef">Time</span>: <span style="color:#ae81ff">19</span>
  State: Executing <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>
   Info: <span style="color:#66d9ef">update</span> t_order <span style="color:#66d9ef">set</span> version <span style="color:#f92672">=</span> <span style="color:#ae81ff">456</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">24</span> sec)
</code></pre></div><p><code>Kill &lt;processID&gt;</code>: This command is implemented based on <code>Show processlist</code> and can terminate the running SQL listed in the <code>Show processlist</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">kill</span> <span style="color:#ae81ff">82</span>a67f254959e0a0807a00f3cd695d87;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">17</span> sec)
</code></pre></div><h1 id="2-how-do-they-work">2. How do they work?</h1>
<p>Now that you understand the functions of <code>Show processlist</code> and <code>Kill &lt;processID&gt;</code>, let&rsquo;s see how the two commands work. As the working principle behind <code>Kill &lt;processID&gt;</code> is similar to that of <code>Show processlist</code>, we&rsquo;ll focus on the interpretation of <code>Show processlist</code>.</p>
<h2 id="21-how-is-sql-saved-and-destroyed">2.1 How is SQL saved and destroyed?</h2>
<p>Each SQL executed in ShardingSphere will generate an <code>ExecutionGroupContext</code> object. The object contains all the information about this SQL, among which there is an <code>processID</code> field to ensure its uniqueness.</p>
<p>When ShardingSphere receives a SQL command, the <code>GovernanceExecuteProcessReporter# report</code> is called to store <code>ExecutionGroupContext</code> information into the cache of <code>ConcurrentHashMap </code>(currently only DML and DDL statements of MySQL are supported; other types of databases will be supported in later versions. Query statements are also classified into DML).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GovernanceExecuteProcessReporter</span> <span style="color:#66d9ef">implements</span> ExecuteProcessReporter <span style="color:#f92672">{</span>
    
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">report</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> QueryContext queryContext<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ExecutionGroupContext<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> SQLExecutionUnit<span style="color:#f92672">&gt;</span> executionGroupContext<span style="color:#f92672">,</span>
                       <span style="color:#66d9ef">final</span> ExecuteProcessConstants constants<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> EventBusContext eventBusContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ExecuteProcessContext process <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExecuteProcessContext<span style="color:#f92672">(</span>queryContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getSql</span><span style="color:#f92672">(),</span> executionGroupContext<span style="color:#f92672">,</span> constants<span style="color:#f92672">);</span>
        ShowProcessListManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">putProcessContext</span><span style="color:#f92672">(</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessID</span><span style="color:#f92672">(),</span> process<span style="color:#f92672">);</span>
        ShowProcessListManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">putProcessStatement</span><span style="color:#f92672">(</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessID</span><span style="color:#f92672">(),</span> process<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessStatements</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span><span style="color:#a6e22e">@NoArgsConstructor</span><span style="color:#f92672">(</span>access <span style="color:#f92672">=</span> AccessLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ShowProcessListManager</span> <span style="color:#f92672">{</span>
    
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ShowProcessListManager INSTANCE <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ShowProcessListManager<span style="color:#f92672">();</span>
    
    <span style="color:#a6e22e">@Getter</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> ExecuteProcessContext<span style="color:#f92672">&gt;</span> processes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;&gt;();</span>
    
    <span style="color:#a6e22e">@Getter</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Collection<span style="color:#f92672">&lt;</span>Statement<span style="color:#f92672">&gt;&gt;</span> processStatements <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;&gt;();</span>
 
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ShowProcessListManager <span style="color:#a6e22e">getInstance</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> INSTANCE<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">putProcessContext</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String processID<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ExecuteProcessContext process<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        processes<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>processID<span style="color:#f92672">,</span> process<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">putProcessStatement</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String processID<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Collection<span style="color:#f92672">&lt;</span>Statement<span style="color:#f92672">&gt;</span> statements<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>statements<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        processStatements<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>processID<span style="color:#f92672">,</span> statements<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>As shown above, the <code>ShowProcessListManager</code> class has two cache Maps, namely <code>processes</code> and <code>processStatements</code>. The former stores the mapping between <code>processID</code> and <code>ExecuteProcessContext</code>.</p>
<p>The latter contains the mapping between <code>processID</code> and <code>Statement objects</code> that may generate multiple statements after the SQL is overwritten.</p>
<p>Every time ShardingSphere receives a SQL statement, the SQL information will be cached into the two Maps. After SQL is executed, the cache of Map will be deleted.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@RequiredArgsConstructor</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProxyJDBCExecutor</span> <span style="color:#f92672">{</span>
    
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> String type<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConnectionSession connectionSession<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> JDBCDatabaseCommunicationEngine databaseCommunicationEngine<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> JDBCExecutor jdbcExecutor<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>ExecuteResult<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> QueryContext queryContext<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ExecutionGroupContext<span style="color:#f92672">&lt;</span>JDBCExecutionUnit<span style="color:#f92672">&gt;</span> executionGroupContext<span style="color:#f92672">,</span>
                                       <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isReturnGeneratedKeys<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isExceptionThrown<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> SQLException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            MetaDataContexts metaDataContexts <span style="color:#f92672">=</span> ProxyContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getMetaDataContexts</span><span style="color:#f92672">();</span>
            EventBusContext eventBusContext <span style="color:#f92672">=</span> ProxyContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInstanceContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getEventBusContext</span><span style="color:#f92672">();</span>
            ShardingSphereDatabase database <span style="color:#f92672">=</span> metaDataContexts<span style="color:#f92672">.</span><span style="color:#a6e22e">getMetaData</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDatabase</span><span style="color:#f92672">(</span>connectionSession<span style="color:#f92672">.</span><span style="color:#a6e22e">getDatabaseName</span><span style="color:#f92672">());</span>
            DatabaseType protocolType <span style="color:#f92672">=</span> database<span style="color:#f92672">.</span><span style="color:#a6e22e">getProtocolType</span><span style="color:#f92672">();</span>
            DatabaseType databaseType <span style="color:#f92672">=</span> database<span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDatabaseType</span><span style="color:#f92672">();</span>
            ExecuteProcessEngine<span style="color:#f92672">.</span><span style="color:#a6e22e">initialize</span><span style="color:#f92672">(</span>queryContext<span style="color:#f92672">,</span> executionGroupContext<span style="color:#f92672">,</span> eventBusContext<span style="color:#f92672">);</span>
            SQLStatementContext<span style="color:#f92672">&lt;?&gt;</span> context <span style="color:#f92672">=</span> queryContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getSqlStatementContext</span><span style="color:#f92672">();</span>
            List<span style="color:#f92672">&lt;</span>ExecuteResult<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> jdbcExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>executionGroupContext<span style="color:#f92672">,</span>
                    ProxyJDBCExecutorCallbackFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>type<span style="color:#f92672">,</span> protocolType<span style="color:#f92672">,</span> databaseType<span style="color:#f92672">,</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSqlStatement</span><span style="color:#f92672">(),</span> databaseCommunicationEngine<span style="color:#f92672">,</span> isReturnGeneratedKeys<span style="color:#f92672">,</span> isExceptionThrown<span style="color:#f92672">,</span>
                            <span style="color:#66d9ef">true</span><span style="color:#f92672">),</span>
                    ProxyJDBCExecutorCallbackFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>type<span style="color:#f92672">,</span> protocolType<span style="color:#f92672">,</span> databaseType<span style="color:#f92672">,</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSqlStatement</span><span style="color:#f92672">(),</span> databaseCommunicationEngine<span style="color:#f92672">,</span> isReturnGeneratedKeys<span style="color:#f92672">,</span> isExceptionThrown<span style="color:#f92672">,</span>
                            <span style="color:#66d9ef">false</span><span style="color:#f92672">));</span>
            ExecuteProcessEngine<span style="color:#f92672">.</span><span style="color:#a6e22e">finish</span><span style="color:#f92672">(</span>executionGroupContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessID</span><span style="color:#f92672">(),</span> eventBusContext<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            ExecuteProcessEngine<span style="color:#f92672">.</span><span style="color:#a6e22e">clean</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>As shown above, <code>ExecuteProcessEngine.initialize(queryContext, executionGroupContext, eventBusContext);</code> will store the SQL information in the two cache Maps. Finally, <code>ExecuteProcessEngine.clean();</code> in the code block will clear up the Map in the cache.</p>
<p>The SQL shown in the <code>Show processlist</code> was obtained from <code>processes</code>. But this Map is just a local cache. If ShardingSphere is deployed in cluster mode, how does <code>Show processlist</code> obtain SQL running on other machines in the cluster? Let&rsquo;s see how ShardingSphere handles it.</p>
<h2 id="22-how-does-show-processlist-work">2.2 How does <code>Show processlist</code> work?</h2>
<p>When ShardingSphere receives the <code>Show process</code> command, it is sent to the executor <code>ShowProcessListExecutor#execute</code> for processing. The implementation of the <code>getQueryResult()</code> is the focus.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ShowProcessListExecutor</span> <span style="color:#66d9ef">implements</span> DatabaseAdminQueryExecutor <span style="color:#f92672">{</span>
    
    <span style="color:#66d9ef">private</span> Collection<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> batchProcessContexts<span style="color:#f92672">;</span>
    
    <span style="color:#a6e22e">@Getter</span>
    <span style="color:#66d9ef">private</span> QueryResultMetaData queryResultMetaData<span style="color:#f92672">;</span>
    
    <span style="color:#a6e22e">@Getter</span>
    <span style="color:#66d9ef">private</span> MergedResult mergedResult<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ShowProcessListExecutor</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        ProxyContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInstanceContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getEventBusContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#a6e22e">@Subscribe</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">receiveProcessListData</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ShowProcessListResponseEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        batchProcessContexts <span style="color:#f92672">=</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">getBatchProcessContexts</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ConnectionSession connectionSession<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        queryResultMetaData <span style="color:#f92672">=</span> createQueryResultMetaData<span style="color:#f92672">();</span>
        mergedResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransparentMergedResult<span style="color:#f92672">(</span>getQueryResult<span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">private</span> QueryResult <span style="color:#a6e22e">getQueryResult</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        ProxyContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInstanceContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getEventBusContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ShowProcessListRequestEvent<span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> batchProcessContexts <span style="color:#f92672">||</span> batchProcessContexts<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RawMemoryQueryResult<span style="color:#f92672">(</span>queryResultMetaData<span style="color:#f92672">,</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyList</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        Collection<span style="color:#f92672">&lt;</span>YamlExecuteProcessContext<span style="color:#f92672">&gt;</span> processes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String each <span style="color:#f92672">:</span> batchProcessContexts<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            processes<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span>YamlEngine<span style="color:#f92672">.</span><span style="color:#a6e22e">unmarshal</span><span style="color:#f92672">(</span>each<span style="color:#f92672">,</span> BatchYamlExecuteProcessContext<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getContexts</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        List<span style="color:#f92672">&lt;</span>MemoryQueryResultDataRow<span style="color:#f92672">&gt;</span> rows <span style="color:#f92672">=</span> processes<span style="color:#f92672">.</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">().</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>process <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
            List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> rowValues <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>8<span style="color:#f92672">);</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessIDID</span><span style="color:#f92672">());</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">());</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">getHostname</span><span style="color:#f92672">());</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>process<span style="color:#f92672">.</span><span style="color:#a6e22e">getDatabaseName</span><span style="color:#f92672">());</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Execute&#34;</span><span style="color:#f92672">);</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">.</span><span style="color:#a6e22e">toSeconds</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> process<span style="color:#f92672">.</span><span style="color:#a6e22e">getStartTimeMillis</span><span style="color:#f92672">()));</span>
            <span style="color:#66d9ef">int</span> processDoneCount <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span><span style="color:#a6e22e">getUnitStatuses</span><span style="color:#f92672">().</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">().</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>each <span style="color:#f92672">-&gt;</span> ExecuteProcessConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">EXECUTE_STATUS_DONE</span> <span style="color:#f92672">==</span> each<span style="color:#f92672">.</span><span style="color:#a6e22e">getStatus</span><span style="color:#f92672">()</span> <span style="color:#f92672">?</span> 1 <span style="color:#f92672">:</span> 0<span style="color:#f92672">).</span><span style="color:#a6e22e">reduce</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> Integer<span style="color:#f92672">::</span>sum<span style="color:#f92672">);</span>
            String statePrefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Executing &#34;</span><span style="color:#f92672">;</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>statePrefix <span style="color:#f92672">+</span> processDoneCount <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> process<span style="color:#f92672">.</span><span style="color:#a6e22e">getUnitStatuses</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
            String sql <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span><span style="color:#a6e22e">getSql</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> sql <span style="color:#f92672">&amp;&amp;</span> sql<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 100<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                sql <span style="color:#f92672">=</span> sql<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 100<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            rowValues<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> sql <span style="color:#f92672">?</span> sql <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> MemoryQueryResultDataRow<span style="color:#f92672">(</span>rowValues<span style="color:#f92672">);</span>
        <span style="color:#f92672">}).</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>Collectors<span style="color:#f92672">.</span><span style="color:#a6e22e">toList</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RawMemoryQueryResult<span style="color:#f92672">(</span>queryResultMetaData<span style="color:#f92672">,</span> rows<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">private</span> QueryResultMetaData <span style="color:#a6e22e">createQueryResultMetaData</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        List<span style="color:#f92672">&lt;</span>RawQueryResultColumnMetaData<span style="color:#f92672">&gt;</span> columns <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Id&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Id&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 20<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;User&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;User&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 20<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Host&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Host&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 64<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;db&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;db&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 64<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Command&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Command&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 64<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Time&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Time&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 10<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;State&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;State&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 64<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        columns<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RawQueryResultColumnMetaData<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Info&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Info&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">VARCHAR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;VARCHAR&#34;</span><span style="color:#f92672">,</span> 120<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RawQueryResultMetaData<span style="color:#f92672">(</span>columns<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>You’ll use the <code>guava</code> package&rsquo;s <code>EventBus</code> function, which is an information publish/subscribe database that is an elegant implementation of the <a href="https://en.wikipedia.org/wiki/Observer_pattern">Observer pattern</a>. <code>EventBus</code> decouples classes from each other, and you&rsquo;ll find out more about it below.</p>
<p><code>getQueryResult()</code> method will post <code>ShowProcessListRequestEvent</code>. <code>ProcessRegistrySubscriber#loadShowProcessListData</code> uses the <code>@Subscribe</code> annotations to subscribe to the event.</p>
<p>This method is the core to implementing <code>Show processlist</code>. Next, we&rsquo;ll introduce specific procedures of this method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProcessRegistrySubscriber</span> <span style="color:#f92672">{</span>    
    <span style="color:#a6e22e">@Subscribe</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadShowProcessListData</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ShowProcessListRequestEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        String processId <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UUID<span style="color:#f92672">(</span>ThreadLocalRandom<span style="color:#f92672">.</span><span style="color:#a6e22e">current</span><span style="color:#f92672">().</span><span style="color:#a6e22e">nextLong</span><span style="color:#f92672">(),</span> ThreadLocalRandom<span style="color:#f92672">.</span><span style="color:#a6e22e">current</span><span style="color:#f92672">().</span><span style="color:#a6e22e">nextLong</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">().</span><span style="color:#a6e22e">replace</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">boolean</span> triggerIsComplete <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 1. Obtain the Process List path of all existing proxy nodes in cluster mode
</span><span style="color:#75715e"></span>        Collection<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> triggerPaths <span style="color:#f92672">=</span> getTriggerPaths<span style="color:#f92672">(</span>processId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 2. Iterate through the path and write an empty string to the node, to trigger the node monitoring.
</span><span style="color:#75715e"></span>            triggerPaths<span style="color:#f92672">.</span><span style="color:#a6e22e">forEach</span><span style="color:#f92672">(</span>each <span style="color:#f92672">-&gt;</span> repository<span style="color:#f92672">.</span><span style="color:#a6e22e">persist</span><span style="color:#f92672">(</span>each<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">));</span>
            <span style="color:#75715e">// 3. Lock and wait 5 seconds for each node to write the information of currently running SQL to the persistence layer. 
</span><span style="color:#75715e"></span>            triggerIsComplete <span style="color:#f92672">=</span> waitAllNodeDataReady<span style="color:#f92672">(</span>processId<span style="color:#f92672">,</span> triggerPaths<span style="color:#f92672">);</span>
            <span style="color:#75715e">// 4. Fetch and aggregate the data written by each proxy node from the persistence layer. Then EventBus will post a ShowProcessListResponseEvent command, which means the operation is completed.
</span><span style="color:#75715e"></span>            sendShowProcessList<span style="color:#f92672">(</span>processId<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 5. Delete resources
</span><span style="color:#75715e"></span>            repository<span style="color:#f92672">.</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">(</span>ProcessNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessIdPath</span><span style="color:#f92672">(</span>processId<span style="color:#f92672">));</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>triggerIsComplete<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                triggerPaths<span style="color:#f92672">.</span><span style="color:#a6e22e">forEach</span><span style="color:#f92672">(</span>repository<span style="color:#f92672">::</span>delete<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>It contains five steps and steps 2 &amp; 3 are the focus.</p>
<h3 id="221-step-2-the-cluster-obtains-the-data-implementation">2.2.1 Step 2: the cluster obtains the data implementation</h3>
<p>In this step, an empty string will be written to the node <code>/nodes/compute_nodes/show_process_list_trigger/&lt;instanceId&gt;:&lt;processId&gt;</code>, which will trigger ShardingSphere&rsquo;s monitoring logic.</p>
<p>When ShardingSphere is started, the persistence layer will <code>watch</code> to monitor a series of path changes, such as the addition, deletion, and modification operations of the path <code>/nodes/compute_nodes</code>.</p>
<p>However, monitoring is an asynchronous process and the main thread does not block, so step 3 is required to lock and wait for each ShardingSphere node to write its currently running SQL information into the persistence layer.</p>
<p>Let&rsquo;s take a look at how the ShardingSphere handles the monitoring logic.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ComputeNodeStateChangedWatcher</span> <span style="color:#66d9ef">implements</span> GovernanceWatcher<span style="color:#f92672">&lt;</span>GovernanceEvent<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Collection<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getWatchingKeys</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String databaseName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singleton</span><span style="color:#f92672">(</span>ComputeNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getComputeNodePath</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Collection<span style="color:#f92672">&lt;</span>Type<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getWatchingTypes</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>Type<span style="color:#f92672">.</span><span style="color:#a6e22e">ADDED</span><span style="color:#f92672">,</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">UPDATED</span><span style="color:#f92672">,</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">DELETED</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Optional<span style="color:#f92672">&lt;</span>GovernanceEvent<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">createGovernanceEvent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> DataChangedEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        String instanceId <span style="color:#f92672">=</span> ComputeNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstanceIdByComputeNode</span><span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>Strings<span style="color:#f92672">.</span><span style="color:#a6e22e">isNullOrEmpty</span><span style="color:#f92672">(</span>instanceId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">...</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">().</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>ComputeNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getOnlineInstanceNodePath</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> createInstanceEvent<span style="color:#f92672">(</span>event<span style="color:#f92672">);</span>
            <span style="color:#75715e">// show processlist
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">().</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>ComputeNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessTriggerNodePatch</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> createShowProcessListTriggerEvent<span style="color:#f92672">(</span>event<span style="color:#f92672">);</span>
            <span style="color:#75715e">// kill processId
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">().</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>ComputeNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessKillNodePatch</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> createKillProcessIdEvent<span style="color:#f92672">(</span>event<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">empty</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
        
    <span style="color:#66d9ef">private</span> Optional<span style="color:#f92672">&lt;</span>GovernanceEvent<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">createShowProcessListTriggerEvent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> DataChangedEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Matcher matcher <span style="color:#f92672">=</span> getShowProcessTriggerMatcher<span style="color:#f92672">(</span>event<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>matcher<span style="color:#f92672">.</span><span style="color:#a6e22e">find</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">empty</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Type<span style="color:#f92672">.</span><span style="color:#a6e22e">ADDED</span> <span style="color:#f92672">==</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ShowProcessListTriggerEvent<span style="color:#f92672">(</span>matcher<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span>1<span style="color:#f92672">),</span> matcher<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span>2<span style="color:#f92672">)));</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Type<span style="color:#f92672">.</span><span style="color:#a6e22e">DELETED</span> <span style="color:#f92672">==</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ShowProcessListUnitCompleteEvent<span style="color:#f92672">(</span>matcher<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span>2<span style="color:#f92672">)));</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">empty</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>After <code>ComputeNodeStateChangedWatcher#createGovernanceEvent</code> monitored the information, it would distinguish which event to create according to the path.</p>
<p>As shown in the above code, it is a new node, so <code>ShowProcessListTriggerEvent</code> will be posted. As each ShardingSphere instance will monitor <code>/nodes/compute_nodes</code>, each instance will process <code>ShowProcessListTriggerEvent</code>.</p>
<p>In this case, single-machine processing is transformed into cluster processing. Let&rsquo;s look at how ShardingSphere handles it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClusterContextManagerCoordinator</span> <span style="color:#f92672">{</span>    <span style="color:#a6e22e">@Subscribe</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">triggerShowProcessList</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ShowProcessListTriggerEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstanceId</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>contextManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstanceContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getMetaData</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        Collection<span style="color:#f92672">&lt;</span>ExecuteProcessContext<span style="color:#f92672">&gt;</span> processes <span style="color:#f92672">=</span> ShowProcessListManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAllProcessContext</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>processes<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            registryCenter<span style="color:#f92672">.</span><span style="color:#a6e22e">getRepository</span><span style="color:#f92672">().</span><span style="color:#a6e22e">persist</span><span style="color:#f92672">(</span>ProcessNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessListInstancePath</span><span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessId</span><span style="color:#f92672">(),</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstanceId</span><span style="color:#f92672">()),</span>
                    YamlEngine<span style="color:#f92672">.</span><span style="color:#a6e22e">marshal</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BatchYamlExecuteProcessContext<span style="color:#f92672">(</span>processes<span style="color:#f92672">)));</span>
        <span style="color:#f92672">}</span>
        registryCenter<span style="color:#f92672">.</span><span style="color:#a6e22e">getRepository</span><span style="color:#f92672">().</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">(</span>ComputeNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessTriggerInstanceIdNodePath</span><span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstanceId</span><span style="color:#f92672">(),</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessId</span><span style="color:#f92672">()));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ClusterContextManagerCoordinator#triggerShowProcessList</code> will subscribe to <code>ShowProcessListTriggerEvent</code>, in which <code>process</code> data is processed by itself. <code>ShowProcessListManager.getInstance().getAllProcessContext()</code> retrieves the <code>process</code> that is currently running (here the data refers to the SQL information that ShardingSphere stores in the Map before each SQL execution, which is described at the beginning of the article) and transfers it to the persistence layer. If the <code>/nodes/compute_nodes/show_process_list_trigger/&lt;instanceId&gt;:&lt;processId&gt;</code> node is deleted, the processing is completed.</p>
<p>When you delete the node, monitoring will also be triggered and <code>ShowProcessListUnitCompleteEvent</code> will be posted. This event will finally awake the pending lock.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClusterContextManagerCoordinator</span> <span style="color:#f92672">{</span>
    
    <span style="color:#a6e22e">@Subscribe</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">completeUnitShowProcessList</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ShowProcessListUnitCompleteEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ShowProcessListLock lock <span style="color:#f92672">=</span> ShowProcessListManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLocks</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessId</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> lock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            lock<span style="color:#f92672">.</span><span style="color:#a6e22e">doNotify</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="222-step-3-lock-and-wait-for-the-data-implementation">2.2.2 Step 3: lock and wait for the data implementation</h3>
<p>ShardingSphere uses the <code>isReady(Paths)</code> method to determine whether all instances have been processed. It returns <code>true</code> only when all instances have been processed.</p>
<p>There is a maximum waiting time of 5 seconds for data processing. If the processing is not completed in 5 seconds, then <code>false</code> is returned.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClusterContextManagerCoordinator</span> <span style="color:#f92672">{</span>
    
    <span style="color:#a6e22e">@Subscribe</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">completeUnitShowProcessList</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ShowProcessListUnitCompleteEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ShowProcessListLock lock <span style="color:#f92672">=</span> ShowProcessListManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLocks</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessId</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> lock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            lock<span style="color:#f92672">.</span><span style="color:#a6e22e">doNotify</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="223-aggregate-the-processlist-data-and-return-it">2.2.3 Aggregate the <code>processList</code> data and return it</h3>
<p>After each instance processed the data, the instance that received the <code>Show processlist</code> command needs to aggregate the data and then display the result.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProcessRegistrySubscriber</span> <span style="color:#f92672">{</span>  
    
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendShowProcessList</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String processId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> childrenKeys <span style="color:#f92672">=</span> repository<span style="color:#f92672">.</span><span style="color:#a6e22e">getChildrenKeys</span><span style="color:#f92672">(</span>ProcessNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessIdPath</span><span style="color:#f92672">(</span>processId<span style="color:#f92672">));</span>
        Collection<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> batchProcessContexts <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String each <span style="color:#f92672">:</span> childrenKeys<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            batchProcessContexts<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>repository<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>ProcessNode<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessListInstancePath</span><span style="color:#f92672">(</span>processId<span style="color:#f92672">,</span> each<span style="color:#f92672">)));</span>
        <span style="color:#f92672">}</span>
        eventBusContext<span style="color:#f92672">.</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ShowProcessListResponseEvent<span style="color:#f92672">(</span>batchProcessContexts<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ProcessRegistrySubscriber#sendShowProcessList</code> will aggregate the running SQL data into <code>batchProcessContexts</code>, and then post <code>ShowProcessListResponseEvent</code>.</p>
<p>This event will be consumed by <code>ShowProcessListExecutor#receiveProcessListData</code>, and the <code>getQueryResult()</code> method will proceed to show the <code>queryResult</code>.</p>
<p>So far, we’ve completed the execution process of <code>Show processlist</code> command.</p>
<h2 id="23-how-does-kill-processid-work">2.3 How does <code>Kill &lt;processId&gt;</code> work?</h2>
<p><code>Kill &lt;processId&gt;</code> shares a similar logic with <code>Show processlist</code>, that is to combine <code>EventBus</code> with the <code>watch</code> mechanism.</p>
<p>Since we do not know which SQL the <code>processId</code> belongs to, it is also necessary to add empty nodes for each instance.</p>
<p>Through the <code>watch</code> mechanism, each ShardingSphere instance watches to the new node and checks whether the <code>processId</code> key is in the cache Map. If yes, fetch the value corresponding to the key.</p>
<p>The value is a <code>Collection&lt;Statement&gt;</code> collection. Then you only have to iterate through the <code>Statement</code> collection and call <code>statement.cancel()</code> in turn. The underlying layer is <code>java.sql.Statement#cancel()</code> method called to cancel SQL execution.</p>
<h1 id="3-conclusion">3. Conclusion</h1>
<p>Currently, Apache ShardingSphere can only implement the <code>Show processlist</code> and <code>Kill &lt;processId&gt;</code> functions for <a href="https://www.mysql.com/">MySQL</a> dialects.</p>
<p>Once you get to know how they work, and if you’re interested, you‘re welcome to participate in the development of related functions. Our community is very open and anyone who is interested in contributing to open source code is welcome.</p>
<h1 id="relevant-links">Relevant Links:</h1>
<p><a href="https://shardingsphere.apache.org/">Apache ShardingSphere Official Website</a></p>
<p><a href="https://github.com/apache/shardingsphere">Apache ShardingSphere GitHub</a></p>
<p><a href="https://apacheshardingsphere.slack.com/">Apache ShardingSphere Slack Channel</a></p>
<h1 id="author">Author</h1>
<p>Xu Yang, a middleware R&amp;D engineer at <a href="https://www.crunchbase.com/organization/servyou-group">Servyou Group</a>. Responsible for the table and database sharding with massive data. An open source enthusiast and ShardingSphere contributor. Currently, he’s interested in developing the kernel module of the ShardingSphere project.</p>


		
	</div>

	<div class="pagination">
		<a href="https://shardingsphere.apache.org/blog/en/material/2022_10_14_shardingsphere_5.2.0_audit_for_sharding_intercepts_unreasonable_requests_in_multi-shards_scenarios/" class="left arrow">&#8592;</a>
		<a href="https://shardingsphere.apache.org/blog/en/material/2022_09_08_apache_shardingsphere_5.2.0_is_released_bringing_new_cloud_native_possibilities/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			
			Copyright &copy; 2018-2020, <a href="https://shardingsphere.apache.org/blog/">Apache ShardingSphere</a>, ShardingSphere, Apache, the Apache feather logo, and the Apache ShardingSphere project logo are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.
			</span>
		</footer>

    </body>
</html>
